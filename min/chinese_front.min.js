function debug(e){document.getElementById("db").innerHTML+=e+"<br>"}function parse(e,n){try{var r=[],t=hanziParser.parse(e),i=chunkParser.parse(n);if(t.length!=i.length)throw"Length of hanzi and pinyin chunks do not match";for(var a=0;a<t.length;a++){if(t[a].type!=i[a].type)throw"Types of hanzi and pinyin chunk do not match";var o=t[a],u="word"===i[a].type?pinyinParser.parse(i[a].content):{chars:i[a].content,tone:5};r.push({hanzi:o.content,pinyin:u.chars,tone:u.tone})}return r}catch(c){return void 0}}function isBackSide(){return null!=document.getElementById("answer")}function getToneColor(e){switch(e){case"1":return{hanzi:"#C0392B",pinyin:"#E74C3C"};case"2":return{hanzi:"#27AE60",pinyin:"#2ECC71"};case"3":return{hanzi:"#2980B9",pinyin:"#3498DB"};case"4":return{hanzi:"#8E44AD",pinyin:"#9B59B6"};default:return{hanzi:"#7F8C8D",pinyin:"#95A5A6"}}}function getVocalPriority(e){var n=vocalMap[e];return n=null!=n?n.priority:5}function getCharWithTone(e,n){console.log(n);var r="",t=vocalMap[e];if(null!=t){var i=t.tone[n];r=null!=i?i:t[5]}else r=e;return r}function makeTonemarks(e,n){console.log(e);for(var r=e,t=6,i=-1,a=0;a<e.length;a++){var o=e.charAt(a),u=getVocalPriority(o);t>u&&(t=u,i=a)}if(-1!==i){var o=e.charAt(i),c=getCharWithTone(o,n);console.log(c),r=e.replace(o,c)}return r}function createTemplate(e,n,r,t){if(e){for(var i=document.getElementById(n),a=document.createElement("wrap"),o=0;o<e.length;o++){var u=document.createElement("character"),c=getToneColor(e[o].tone),d=document.createElement("hanzi");d.innerHTML=e[o].hanzi,d.style.background=c.hanzi;var h=document.createElement("pinyin");savedPinyin.push(makeTonemarks(e[o].pinyin,e[o].tone)),h.innerHTML="&zwnj;",h.style.background=c.pinyin,u.appendChild(d),u.appendChild(h),a.appendChild(u),i.appendChild(a)}document.getElementById(r).outerHTML="",document.getElementById(t).outerHTML=""}}function processTranslation(e,n){var r=document.getElementById(n);document.getElementById(n).innerHTML="";var t=e.split(";");if(null!=t)for(var i=0;i<t.length;i++){var a=document.createElement("div");a.innerHTML=t[i],r.appendChild(a)}}try{var savedPinyin=[],ChunkGrammar="Chunks = chunk:Chunk+ { return chunk; }; Chunk = chunk:(Divider / Word) (WS)? { return chunk; }; Word = word:[^ ,\\.!?/0-9]+ tone:[1-5]? { var result = ''; for (var i = 0; i < word.length; i++) { result += word[i]; } if(tone) result += tone; return { content: result, type: 'word' }; }; Divider = divider:SYMS+ { var result = ''; for (var i = 0; i < divider.length; i++) { result += divider[i]; } return { content: result, type: 'divider' }; }; SYMS = [,\\.!?/]; WS = [ \\t\\n\\r]*",HanziGrammar="Chunks = chunk:Chunk+ { return chunk; }; Chunk = chunk:(Divider / Word) (WS)? { return chunk; }; Word = word:[^ ,\\.!?/] { var result = ''; for (var i = 0; i < word.length; i++) { result += word[i]; } return { content: result, type: 'word' }; }; Divider = divider:SYMS+ { var result = ''; for (var i = 0; i < divider.length; i++) { result += divider[i]; } return { content: result, type: 'divider' }; }; SYMS = [,\\.!?/];  WS = [ \\t\\n\\r]*",PinyinGrammar="Pinyin = chars:Chars tone:(Tone)? { return { chars: chars, tone: (tone) ? tone : 5 }; }; Chars = char:Char+ { var result = ''; for(var i = 0; i < char.length; i++) { result += char[i]; } return result; }; Char = [a-zA-Z]; Tone = [1-5] ",chunkParser=peg.generate(ChunkGrammar),hanziParser=peg.generate(HanziGrammar),pinyinParser=peg.generate(PinyinGrammar),vocalMap={a:{priority:1,tone:{1:"&#257;",2:"&#225;",3:"&#462;",4:"&#224;",5:"a"}},e:{priority:2,tone:{1:"&#275;",2:"&#233;",3:"&#283;",4:"&#232;",5:"e"}},o:{priority:3,tone:{1:"&#333;",2:"&#243;",3:"&#466;",4:"&#242;",5:"o"}},u:{priority:4,tone:{1:"&#363;",2:"&#250;",3:"&#468;",4:"&#249;",5:"u"}},i:{priority:4,tone:{1:"&#299;",2:"&#237;",3:"&#464;",4:"&#236;",5:"i"}},v:{priority:4,tone:{1:"&#470;",2:"&#472;",3:"&#474;",4:"&#476;",5:"&#252;"}}},hanziText=document.getElementById("hz").innerHTML,pinyinText=document.getElementById("py").innerHTML,words=parse(hanziText,pinyinText);createTemplate(words,"ch","hz","py")}catch(err){document.getElementById("db").innerHTML=err}